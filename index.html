<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Baby Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- QR and Compression libs -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 1.5em;
    }
    video {
      width: 90%;
      max-width: 480px;
      border-radius: 8px;
      margin: 1em 0;
      background: black;
    }
    button {
      margin: 0.5em;
      padding: 0.7em 1.5em;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      font-size: 1em;
    }
    button:hover {
      background: #0056c7;
    }
    #qr {
      margin-top: 10px;
    }
    textarea {
      width: 90%;
      height: 100px;
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <h2>ðŸ“· Baby Monitor</h2>
  <div>
    <button id="cameraModeBtn">Start Camera Mode</button>
    <button id="monitorModeBtn">Start Monitor Mode</button>
  </div>

  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <div id="qr"></div>
  <textarea id="manualBox" placeholder="QR or manual text"></textarea>
  <canvas id="scanCanvas" hidden></canvas>

  <script>
    let pc, localVideo = document.getElementById("localVideo"),
        remoteVideo = document.getElementById("remoteVideo"),
        qrHolder = document.getElementById("qr"),
        manualBox = document.getElementById("manualBox"),
        qrInstance = null;

    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    document.getElementById("cameraModeBtn").onclick = startCameraMode;
    document.getElementById("monitorModeBtn").onclick = startMonitorMode;

    async function startCameraMode() {
      clearAll();
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = stream;
      pc = new RTCPeerConnection(servers);
      stream.getTracks().forEach(t => pc.addTrack(t, stream));

      pc.onicecandidate = e => {
        if (e.candidate === null) {
          const sdpText = JSON.stringify(pc.localDescription);
          showQRCode(sdpText);
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    }

    async function startMonitorMode() {
      clearAll();
      const video = remoteVideo;
      pc = new RTCPeerConnection(servers);

      pc.ontrack = e => {
        video.srcObject = e.streams[0];
      };

      // Enable camera for scanning QR
      const scanCanvas = document.getElementById('scanCanvas');
      const ctx = scanCanvas.getContext('2d');
      const scanVideo = document.createElement('video');
      scanVideo.setAttribute('playsinline', true);
      scanVideo.autoplay = true;
      scanVideo.muted = true;

      const camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      scanVideo.srcObject = camStream;

      function scanLoop() {
        if (scanVideo.readyState === scanVideo.HAVE_ENOUGH_DATA) {
          scanCanvas.width = scanVideo.videoWidth;
          scanCanvas.height = scanVideo.videoHeight;
          ctx.drawImage(scanVideo, 0, 0, scanCanvas.width, scanCanvas.height);
          const img = ctx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
          const code = jsQR(img.data, img.width, img.height);
          if (code) {
            console.log("QR scanned!");
            applyReceivedOffer(code.data);
            camStream.getTracks().forEach(t => t.stop());
            return;
          }
        }
        requestAnimationFrame(scanLoop);
      }
      scanLoop();
    }

    function clearAll() {
      qrHolder.innerHTML = "";
      manualBox.value = "";
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
    }

    function showQRCode(text) {
      qrHolder.innerHTML = "";
      try {
        const compressed = pako.deflate(text, { to: 'string' });
        const b64 = btoa(compressed);
        console.log('Original length', text.length, 'Compressed length', b64.length);

        qrInstance = new QRCode(qrHolder, {
          text: b64,
          width: 256,
          height: 256,
          correctLevel: QRCode.CorrectLevel.M
        });

        manualBox.value = b64;
      } catch (e) {
        console.error('QR render failed', e);
        qrHolder.textContent = 'QR render failed: ' + e.message;
      }
    }

    async function applyReceivedOffer(offerText) {
      try {
        let decompressedText = offerText;
        try {
          const decoded = atob(offerText);
          const inflated = pako.inflate(decoded, { to: 'string' });
          decompressedText = inflated;
          console.log('Decompressed offer from', offerText.length, 'to', decompressedText.length);
        } catch (e) {
          console.log('Offer not compressed or already JSON, continuing...');
        }

        const offer = JSON.parse(decompressedText);
        await pc.setRemoteDescription(offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        // Generate answer QR
        pc.onicecandidate = e => {
          if (e.candidate === null) {
            const sdpText = JSON.stringify(pc.localDescription);
            showQRCode(sdpText);
          }
        };
      } catch (e) {
        console.error("Failed to apply offer:", e);
      }
    }

    async function applyReceivedAnswer(answerText) {
      try {
        let decompressedText = answerText;
        try {
          const decoded = atob(answerText);
          const inflated = pako.inflate(decoded, { to: 'string' });
          decompressedText = inflated;
          console.log('Decompressed answer from', answerText.length, 'to', decompressedText.length);
        } catch (e) {
          console.log('Answer not compressed or already JSON, continuing...');
        }

        const answer = JSON.parse(decompressedText);
        await pc.setRemoteDescription(answer);
      } catch (e) {
        console.error("Failed to apply answer:", e);
      }
    }
  </script>
</body>
</html>
