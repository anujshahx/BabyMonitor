<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Baby Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #fafafa;
      margin: 0;
      padding: 1em;
    }
    video {
      width: 90%;
      max-width: 480px;
      margin: 1em auto;
      display: block;
      background: black;
      border-radius: 6px;
    }
    button {
      margin: 0.5em;
      padding: 0.7em 1.2em;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #005ec2;
    }
    #qr {
      margin-top: 1em;
    }
    textarea {
      width: 90%;
      height: 100px;
      margin-top: 1em;
    }
  </style>
</head>

<body>
  <h2>ðŸ“· Baby Monitor</h2>
  <button id="cameraBtn">Start Camera Mode</button>
  <button id="monitorBtn">Start Monitor Mode</button>

  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <div id="qr"></div>
  <textarea id="manualBox" placeholder="Manual offer/answer text (if QR fails)"></textarea>

  <canvas id="scanCanvas" hidden></canvas>

  <script>
    const cameraBtn = document.getElementById('cameraBtn');
    const monitorBtn = document.getElementById('monitorBtn');
    const qrDiv = document.getElementById('qr');
    const manualBox = document.getElementById('manualBox');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    let pcCamera, pcMonitor;

    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    cameraBtn.onclick = startCameraMode;
    monitorBtn.onclick = startMonitorMode;

    async function startCameraMode() {
      clearUI();
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = stream;

      pcCamera = new RTCPeerConnection(servers);
      stream.getTracks().forEach(t => pcCamera.addTrack(t, stream));

      pcCamera.onicecandidate = e => {
        if (e.candidate === null) {
          const offer = JSON.stringify(pcCamera.localDescription);
          showQRCode(offer);
        }
      };

      const offer = await pcCamera.createOffer();
      await pcCamera.setLocalDescription(offer);
    }

    async function startMonitorMode() {
      clearUI();
      pcMonitor = new RTCPeerConnection(servers);

      pcMonitor.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };

      // Try QR scanning
      const scanCanvas = document.getElementById('scanCanvas');
      const ctx = scanCanvas.getContext('2d');
      const scanVideo = document.createElement('video');
      scanVideo.setAttribute('playsinline', true);
      scanVideo.autoplay = true;
      scanVideo.muted = true;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        scanVideo.srcObject = stream;

        function scanLoop() {
          if (scanVideo.readyState === scanVideo.HAVE_ENOUGH_DATA) {
            scanCanvas.width = scanVideo.videoWidth;
            scanCanvas.height = scanVideo.videoHeight;
            ctx.drawImage(scanVideo, 0, 0, scanCanvas.width, scanCanvas.height);
            const imgData = ctx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
            const code = jsQR(imgData.data, imgData.width, imgData.height);
            if (code) {
              console.log("QR detected");
              stream.getTracks().forEach(t => t.stop());
              applyOffer(code.data);
              return;
            }
          }
          requestAnimationFrame(scanLoop);
        }
        scanLoop();
      } catch (err) {
        console.error("Camera for scanning not available:", err);
      }
    }

    function clearUI() {
      qrDiv.innerHTML = "";
      manualBox.value = "";
    }

    function showQRCode(text) {
      qrDiv.innerHTML = "";
      try {
        // Primary compression: LZString
        let compressed = LZString.compressToEncodedURIComponent(text);
        console.log("Original:", text.length, "LZ compressed:", compressed.length);

        // Fallback to Pako if LZString fails
        if (!compressed || compressed.length > 1800) {
          console.log("Using Pako fallback...");
          const deflated = pako.deflateRaw(text);
          const b64 = btoa(String.fromCharCode(...deflated))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
          compressed = b64;
        }

        if (compressed.length > 1800) {
          throw new Error("QR data too long (" + compressed.length + ")");
        }

        new QRCode(qrDiv, {
          text: compressed,
          width: 220,
          height: 220,
          correctLevel: QRCode.CorrectLevel.M
        });

        manualBox.value = compressed;
        console.log("âœ… QR generated successfully, length:", compressed.length);
      } catch (err) {
        console.error("QR render failed", err);
        qrDiv.textContent = "QR generation failed: " + err.message + ". Use manual copy/paste.";
        manualBox.value = text;
      }
    }

    async function applyOffer(qrData) {
      try {
        let jsonText;

        // Try LZString first
        try {
          jsonText = LZString.decompressFromEncodedURIComponent(qrData);
          if (!jsonText) throw new Error("Empty after LZ decompress");
        } catch {
          console.log("Fallback: pako decode");
          const bin = atob(qrData.replace(/-/g, '+').replace(/_/g, '/'));
          const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
          jsonText = pako.inflate(bytes, { to: 'string' });
        }

        const offer = JSON.parse(jsonText);
        await pcMonitor.setRemoteDescription(offer);
        const answer = await pcMonitor.createAnswer();
        await pcMonitor.setLocalDescription(answer);

        pcMonitor.onicecandidate = e => {
          if (e.candidate === null) {
            const answerStr = JSON.stringify(pcMonitor.localDescription);
            showQRCode(answerStr);
          }
        };
      } catch (err) {
        console.error("Failed to apply offer:", err);
        alert("Error applying offer: " + err.message);
      }
    }

    manualBox.addEventListener('change', async () => {
      const txt = manualBox.value.trim();
      if (!txt) return;

      if (pcCamera && !pcCamera.remoteDescription) {
        await applyAnswer(txt);
      } else if (pcMonitor && !pcMonitor.remoteDescription) {
        await applyOffer(txt);
      }
    });

    async function applyAnswer(answerText) {
      try {
        let jsonText;
        try {
          jsonText = LZString.decompressFromEncodedURIComponent(answerText);
          if (!jsonText) throw new Error("Empty after LZ decompress");
        } catch {
          const bin = atob(answerText.replace(/-/g, '+').replace(/_/g, '/'));
          const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
          jsonText = pako.inflate(bytes, { to: 'string' });
        }

        const answer = JSON.parse(jsonText);
        await pcCamera.setRemoteDescription(answer);
      } catch (err) {
        console.error("Failed to apply answer:", err);
        alert("Error applying answer: " + err.message);
      }
    }
  </script>
</body>
</html>
