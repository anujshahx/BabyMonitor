<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="user-scalable=no, width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Baby Monitor</title>
  <style>
    /* App frame: no scrolling, native feel */
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      overflow: hidden; /* prevent page scroll */
      overscroll-behavior: none;
      background: #0b1020;
      color: #0f172a;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, sans-serif;
    }

    :root{
      --brand1:#5b7bff; --brand2:#7a47e8;
      --accent1:#00b894; --accent2:#2ecc71;
      --danger1:#ff6b6b; --danger2:#ee5a6f;
      --bg:#ffffff; --text:#0f172a; --muted:#475569;
      --bar:56px; --pad:14px;
      --shadow:0 18px 50px rgba(0,0,0,.22);
    }

    .app {
      height: 100dvh;
      display: grid;
      grid-template-rows: var(--bar) 1fr;
      background: radial-gradient(1200px 600px at 100% -10%, rgba(255,255,255,.25) 0%, rgba(255,255,255,0) 60%),
                  linear-gradient(135deg, var(--brand1), var(--brand2));
    }

    .appbar {
      height: var(--bar);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 var(--pad);
      color: #fff;
    }
    .brand {
      display: inline-flex; align-items: center; gap: 10px; font-weight: 800;
    }
    .brand svg { width: 22px; height: 22px; display:block; }
    .title { color:#e5e7eb; font-weight:600; font-size:13px; opacity:.9; margin-left: 8px; }

    .content {
      height: 100%;
      padding: var(--pad);
      display: grid;
      place-items: center;
      padding-bottom: var(--pad);
    }

    .card {
      width: min(720px, 100%);
      height: 100%;
      background: var(--bg);
      border-radius: 18px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-rows: 1fr;
      overflow: hidden;
    }

    /* Panels ‚Äì only one is display:block at a time so no overlay can block clicks */
    .panel { display: none; height: 100%; padding: var(--pad); }
    .panel.active { display: block; }

    .section {
      display: flex; align-items: center; gap: 10px;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 14px;
      border-left: 6px solid var(--brand1);
      background: linear-gradient(135deg, #f5f7fa 0%, #eaeffd 100%);
      font-weight: 800;
    }
    .num {
      width: 26px; height: 26px; border-radius: 7px; flex:0 0 26px;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      color:#fff; display:grid; place-items:center; font-size:12px; font-weight:900;
    }

    .stack { height: calc(100% - 58px); display: grid; grid-template-rows: auto 1fr auto; gap: 12px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }

    .status {
      width: 100%; padding: 10px 12px; border-radius: 12px; text-align: center; font-weight: 700; font-size: 13px;
    }
    .info { background:#eaf2fd; color:#174aa7; border:1px solid #c8dbfb; }
    .ok   { background:#e8f7ee; color:#146c2e; border:1px solid #bfe7cb; }
    .err  { background:#fde8ea; color:#821d2a; border:1px solid #f3c2c8; }

    .btn {
      width: 100%; padding: 14px; border: 0; border-radius: 14px; color:#fff;
      font-weight: 800; font-size: 15px; cursor: pointer;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
    }
    .btn.secondary { background: linear-gradient(135deg, var(--accent1), var(--accent2)); }
    .btn.copy { background: linear-gradient(135deg, #f093fb, #f5576c); }
    .btn.stop { background: linear-gradient(135deg, var(--danger1), var(--danger2)); }
    .btn:disabled { opacity:.5; cursor: not-allowed; }

    textarea {
      width: 100%; height: 28vh; min-height: 120px;
      border: 2px solid #e5e7eb; border-radius: 14px; padding: 10px;
      background: #f8fafc; resize: none; overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px; color:#0f172a;
    }

    .video { width: 100%; height: 34vh; min-height: 170px; background:#000; border-radius: 14px; overflow: hidden; position: relative; }
    video { width: 100%; height: 100%; object-fit: cover; background:#000; display: block; }

    /* Monitor controls: dropdown + play + stop; mic FAB on video */
    .controls { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; }
    select {
      width: 100%; border: 2px solid #e5e7eb; border-radius: 14px; background:#fff; padding: 10px;
      font-weight:700; color:#0f172a;
    }
    .fab {
      position: absolute; right: 12px; bottom: 12px; width: 56px; height: 56px;
      border-radius: 50%; border: 0; color:#fff; font-size: 22px; display:none;
      align-items: center; justify-content: center; cursor: pointer;
      background: linear-gradient(135deg, var(--danger1), var(--danger2));
    }
    .fab.active { background: linear-gradient(135deg, #ee5a6f, #c92a2a); }
  </style>
</head>
<body>
  <div class="app">
    <div class="appbar">
      <div class="brand">
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#5b7bff"/><stop offset="100%" stop-color="#7a47e8"/></linearGradient></defs>
          <circle cx="32" cy="32" r="28" fill="url(#g)"/><rect x="18" y="22" width="28" height="20" rx="6" fill="#fff"/><circle cx="32" cy="32" r="6" fill="url(#g)"/>
        </svg>
        Baby Monitor <span class="title" id="title">Home</span>
      </div>
    </div>

    <div class="content">
      <div class="card">

        <!-- HOME -->
        <section id="home" class="panel active">
          <div class="section"><span class="num">‚Ä¢</span>Choose what this device will do</div>
          <div class="stack">
            <div class="row" style="grid-template-columns: 1fr 1fr; gap: 12px;">
              <button class="btn" onclick="initCamera()">üì∑ Use as Camera</button>
              <button class="btn secondary" onclick="showMonitor()">üì∫ Use as Monitor</button>
            </div>
            <div class="row">
              <button class="btn" onclick="resumeLast()">‚Ü© Resume previous pairing</button>
            </div>
            <div class="status info">No login needed; share a code once to connect securely peer‚Äëto‚Äëpeer. </div>
          </div>
        </section>

        <!-- CAMERA -->
        <section id="camera" class="panel">
          <div class="section"><span class="num">1</span>Copy & send to Monitor</div>
          <div class="stack">
            <div class="row">
              <textarea id="offerText" readonly placeholder="Offer will appear here after ICE gathering‚Ä¶"></textarea>
              <button class="btn copy" onclick="copyText('offerText')">üìã Copy Offer</button>
            </div>
            <div class="section"><span class="num">2</span>Paste answer from Monitor</div>
            <div class="row">
              <textarea id="answerInput" placeholder="Paste answer JSON here‚Ä¶"></textarea>
              <button class="btn secondary" onclick="connectCamera()">‚úì Connect</button>
            </div>
            <div id="cameraStatus" class="status info" style="display:none;"></div>
            <div class="video"><video id="cameraVideo" autoplay muted playsinline></video></div>
            <audio id="remoteAudio" autoplay></audio>
          </div>
        </section>

        <!-- MONITOR -->
        <section id="monitor" class="panel">
          <div class="section"><span class="num">1</span>Paste offer from Camera</div>
          <div class="stack">
            <div class="row">
              <textarea id="offerInput" placeholder="Paste offer JSON here‚Ä¶"></textarea>
              <button class="btn" onclick="createAnswer()">üîó Create Answer</button>
            </div>
            <div id="monitorStatus" class="status info" style="display:none;"></div>

            <div class="section"><span class="num">2</span>Copy answer & send to Camera</div>
            <div class="row">
              <textarea id="answerText" readonly placeholder="Answer will appear here‚Ä¶"></textarea>
              <button class="btn copy" onclick="copyText('answerText')">üìã Copy Answer</button>
            </div>

            <div class="video">
              <video id="monitorVideo" autoplay playsinline></video>
              <button id="micBtn" class="fab" title="Hold to Talk"
                onpointerdown="startTalking()" onpointerup="stopTalking()"
                ontouchstart="startTalking()" ontouchend="stopTalking()">üé§</button>
            </div>

            <div class="controls">
              <select id="soundSelect" disabled>
                <option value="">Select lullaby or sound‚Ä¶</option>
                <option value="lullaby1">üéº Twinkle Twinkle</option>
                <option value="lullaby2">üåô Brahms Lullaby</option>
                <option value="whitenoise">üåä White Noise</option>
                <option value="rain">üåßÔ∏è Rain</option>
              </select>
              <button class="btn secondary" id="playBtn" onclick="playSelected()" disabled>‚ñ∂ Play</button>
              <button class="btn stop" id="stopBtn" onclick="sendStop()" disabled>‚èπ Stop</button>
            </div>

            <div id="soundHint" class="status info">Waiting for Camera handshake‚Ä¶ </div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <script>
    /* Simple panel switching ‚Äì no overlays, no animations */
    function showPanel(id){
      ['home','camera','monitor'].forEach(p => {
        const el = document.getElementById(p);
        if (!el) return;
        el.classList.toggle('active', p === id);
      });
      const title = document.getElementById('title');
      title.textContent = id === 'home' ? 'Home' : id.charAt(0).toUpperCase() + id.slice(1);
    }
    function showMonitor(){ showPanel('monitor'); }
    async function initCamera(){ showPanel('camera'); await startCamera(); }

    /* Clipboard (modern API with fallback) */
    async function copyText(textareaId){
      const el = document.getElementById(textareaId);
      const txt = el.value || '';
      try {
        if (navigator.clipboard?.writeText) { await navigator.clipboard.writeText(txt); }
        else { el.select(); document.execCommand('copy'); }
      } catch(e){ alert('Copy failed: ' + e.message); }
    } /* Clipboard write is standard and supported broadly with fallback. [web:292] */

    /* Storage helpers (localStorage preferred) */
    function saveLocal(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch{} } /* localStorage is suitable for multi‚ÄëKB data. [web:336] */
    function loadLocal(key){ try{ return JSON.parse(localStorage.getItem(key)||'null'); }catch{ return null; } } /* Web Storage provides simple key/value persistence. [web:332] */
    function resumeLast(){
      const lastOffer = loadLocal('lastOffer');
      const lastAnswer = loadLocal('lastAnswer');
      if (lastOffer) document.getElementById('offerInput').value = JSON.stringify(lastOffer);
      if (lastAnswer) document.getElementById('answerInput').value = JSON.stringify(lastAnswer);
      alert('Last saved offer/answer (if any) have been prefilled.'); /* Informational UX only. [web:332] */
    }

    /* WebRTC core */
    const rtcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    };

    let pc = null;
    let localStream = null;
    let monitorMicStream = null;
    let monitorMicTrack = null;
    let dataChannel = null;

    // Audio engine (camera) ‚Äì exclusive playback
    let audioCtx = null;
    let gain = null;
    let currentOsc = null;
    let currentSrc = null;
    let melodyTimer = null;
    let melodyActive = false;

    async function startCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:'environment', width:{ideal:1920}, height:{ideal:1080} },
          audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }
        });
        localStream = stream;
        document.getElementById('cameraVideo').srcObject = localStream;

        pc = new RTCPeerConnection(rtcConfig);

        // DataChannel created by camera (offerer) ‚Äì ensures monitor receives ondatachannel
        dataChannel = pc.createDataChannel('ctrl');
        dataChannel.onmessage = (ev)=>{
          try{
            const msg = JSON.parse(ev.data);
            if (msg.action==='play') playSoundOnCamera(msg.sound);
            if (msg.action==='stop') stopSoundOnCamera();
            if (msg.action==='ping') dataChannel.send(JSON.stringify({action:'ready'}));
          }catch{}
        }; /* DC flow allows control messages for sounds. [web:323] */

        // Add local tracks
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream)); /* Tracks are attached via addTrack. [web:327] */

        // Play monitor talk-back on camera
        pc.ontrack = (e)=>{
          if (e.track.kind==='audio' && e.streams[0]){
            const ra = document.getElementById('remoteAudio');
            ra.srcObject = e.streams[0];
            ra.play().catch(()=>{});
          }
        }; /* ontrack provides remote media streams. [web:318] */

        // ICE gather ‚Üí package offer
        const collected = [];
        pc.onicecandidate = (e)=>{ if (e.candidate) collected.push(e.candidate); };
        pc.onicegatheringstatechange = ()=>{
          if (pc.iceGatheringState === 'complete'){
            const offerPkg = { sdp: pc.localDescription, candidates: collected };
            document.getElementById('offerText').value = JSON.stringify(offerPkg);
            saveLocal('lastOffer', offerPkg);
          }
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // Auto-advance confidence: when fully connected, show success
        pc.onconnectionstatechange = ()=>{
          if (pc.connectionState === 'connected'){
            const s = document.getElementById('cameraStatus');
            s.className='status ok'; s.textContent='Connected. Monitor can control sounds.'; s.style.display='block';
          }
        }; /* Using connectionstatechange ensures robust state-driven UI. [web:314] */

      }catch(e){
        const s = document.getElementById('cameraStatus');
        s.className='status err'; s.textContent='Error: '+ e.message; s.style.display='block';
      }
    }

    async function connectCamera(){
      try{
        const raw = document.getElementById('answerInput').value.trim();
        if (!raw) return;
        const answer = JSON.parse(raw);
        await pc.setRemoteDescription(answer.sdp);
        if (answer.candidates) for (const c of answer.candidates) await pc.addIceCandidate(c);
        saveLocal('lastAnswer', answer);
        const s = document.getElementById('cameraStatus');
        s.className='status ok'; s.textContent='Connected. Monitor can control sounds.'; s.style.display='block';
      }catch(e){
        const s = document.getElementById('cameraStatus');
        s.className='status err'; s.textContent='Error: '+ e.message; s.style.display='block';
      }
    }

    async function createAnswer(){
      try{
        const raw = document.getElementById('offerInput').value.trim();
        if (!raw) {
          const s = document.getElementById('monitorStatus');
          s.className='status err'; s.textContent='Paste the offer first.'; s.style.display='block';
          return;
        }
        const offer = JSON.parse(raw);
        const s = document.getElementById('monitorStatus');
        s.className='status info'; s.textContent='Creating connection‚Ä¶'; s.style.display='block';

        pc = new RTCPeerConnection(rtcConfig);

        pc.ondatachannel = (ev)=>{
          dataChannel = ev.channel;
          dataChannel.onopen = ()=>{
            // Persistent ping until camera replies ready
            const ping = setInterval(()=>{
              if (!dataChannel || dataChannel.readyState!=='open') { clearInterval(ping); return; }
              try { dataChannel.send(JSON.stringify({action:'ping'})); } catch {}
            }, 800);
          };
          dataChannel.onmessage = (e)=>{
            try{
              const msg = JSON.parse(e.data);
              if (msg.action==='ready'){
                enableSoundControls();
                const m = document.getElementById('monitorStatus');
                m.className='status ok'; m.textContent='Handshake complete. Sounds ready.'; m.style.display='block';
              }
            }catch{}
          };
        }; /* DC readiness is a reliable gate for enabling controls. [web:317] */

        // Show camera video on monitor
        pc.ontrack = (e)=>{
          if (e.track.kind==='video'){
            document.getElementById('monitorVideo').srcObject = e.streams[0];
            document.getElementById('micBtn').style.display='flex';
          }
        }; /* Remote video arrives via track event. [web:324] */

        // Add monitor mic (muted by default)
        try{
          monitorMicStream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }});
          monitorMicTrack = monitorMicStream.getAudioTracks()[0];
          monitorMicTrack.enabled = false;
          pc.addTrack(monitorMicTrack, monitorMicStream);
        }catch{}

        // ICE gather ‚Üí package answer
        const collected = [];
        pc.onicecandidate = (e)=>{ if (e.candidate) collected.push(e.candidate); };
        pc.onicegatheringstatechange = ()=>{
          if (pc.iceGatheringState === 'complete'){
            const answerPkg = { sdp: pc.localDescription, candidates: collected };
            document.getElementById('answerText').value = JSON.stringify(answerPkg);
            saveLocal('lastAnswer', answerPkg);
            const m = document.getElementById('monitorStatus');
            m.className='status ok'; m.textContent='Answer ready. Copy and send to Camera.'; m.style.display='block';
          }
        };

        await pc.setRemoteDescription(offer.sdp);
        if (offer.candidates) for (const c of offer.candidates) await pc.addIceCandidate(c);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        // Also flip to ready on connection state to avoid UI stalls
        pc.onconnectionstatechange = ()=>{
          if (pc.connectionState === 'connected' && dataChannel?.readyState === 'open'){
            enableSoundControls();
            const m = document.getElementById('monitorStatus');
            m.className='status ok'; m.textContent='Connected. Sounds enabled.'; m.style.display='block';
          }
        }; /* This ensures progress even if message order varies by browser. [web:312] */

      }catch(e){
        const m = document.getElementById('monitorStatus');
        m.className='status err'; m.textContent='Error: ' + e.message; m.style.display='block';
      }
    }

    function enableSoundControls(){
      document.getElementById('soundSelect').disabled = false;
      document.getElementById('playBtn').disabled = false;
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('soundHint').textContent = 'üéµ Sounds ready';
    } /* Enabling controls on DC open/ready is standard for WebRTC UIs. [web:317] */

    function playSelected(){
      const sel = document.getElementById('soundSelect');
      const val = sel.value;
      if (!val) return;
      if (!dataChannel || dataChannel.readyState!=='open') return;
      try{ dataChannel.send(JSON.stringify({ action:'play', sound: val })); }catch{}
    } /* Using dataChannel.send to deliver control commands is typical. [web:326] */
    function sendStop(){
      if (dataChannel && dataChannel.readyState==='open'){
        try{ dataChannel.send(JSON.stringify({ action:'stop' })); }catch{}
      }
    } /* Stop command mirrors the play flow over DC for symmetry. [web:326] */

    function startTalking(){
      const b = document.getElementById('micBtn');
      b.classList.add('active'); b.textContent = 'üî¥';
      if (monitorMicTrack) monitorMicTrack.enabled = true;
    } /* Push-to-talk uses the existing outbound audio track. [web:313] */
    function stopTalking(){
      const b = document.getElementById('micBtn');
      b.classList.remove('active'); b.textContent = 'üé§';
      if (monitorMicTrack) monitorMicTrack.enabled = false;
    } /* Disabling the mic track mutes upstream audio without renegotiation. [web:313] */

    // Audio engine (camera)
    async function ensureAudio(){
      if (!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        gain = audioCtx.createGain(); gain.gain.value = .28; gain.connect(audioCtx.destination);
      }
      if (audioCtx.state==='suspended'){ try{ await audioCtx.resume(); }catch{} }
    } /* Resuming AudioContext is standard for mobile autoplay policies. [web:313] */

    function stopSoundOnCamera(){
      melodyActive=false;
      if (melodyTimer){ try{ clearTimeout(melodyTimer); }catch{} melodyTimer=null; }
      try{ if (currentOsc){ currentOsc.onended=null; currentOsc.stop(0); } }catch{} try{ if (currentOsc) currentOsc.disconnect(); }catch{} currentOsc=null;
      try{ if (currentSrc){ currentSrc.onended=null; currentSrc.stop(0); } }catch{} try{ if (currentSrc) currentSrc.disconnect(); }catch{} currentSrc=null;
    } /* Stopping active nodes ensures exclusive playback. [web:313] */

    async function playSoundOnCamera(kind){
      await ensureAudio();
      stopSoundOnCamera();
      if (kind==='whitenoise') return playWhiteNoise();
      if (kind==='rain') return playRain();
      if (kind==='lullaby1') return playMelody([261.63,261.63,392.00,392.00,440.00,440.00,392.00,349.23,349.23,329.63,329.63,293.66,293.66,261.63], .52, 620);
      if (kind==='lullaby2') return playMelody([329.63,293.66,293.66,329.63,293.66,261.63,293.66,329.63,329.63,293.66], .52, 620);
    } /* Simple tone/noise synthesis avoids CORS/audio file issues on mobile. [web:313] */

    function playMelody(notes, noteDur=.5, gapMs=620){
      melodyActive = true; let i=0;
      const step = ()=>{
        if (!melodyActive) return;
        const osc = audioCtx.createOscillator();
        osc.type = 'sine'; osc.frequency.value = notes[i];
        osc.connect(gain);
        currentOsc = osc;
        const stopAt = audioCtx.currentTime + noteDur;
        osc.start(); osc.stop(stopAt);
        osc.onended = ()=>{ if (!melodyActive) return; i=(i+1)%notes.length; melodyTimer=setTimeout(step, gapMs); };
      };
      step();
    } /* Using one-shot oscillators per note is idiomatic Web Audio for melodies. [web:313] */

    function playWhiteNoise(){
      const n = audioCtx.sampleRate * 2;
      const buf = audioCtx.createBuffer(1, n, audioCtx.sampleRate);
      const ch = buf.getChannelData(0);
      for (let i=0;i<n;i++) ch[i] = Math.random()*2-1;
      const src = audioCtx.createBufferSource();
      src.buffer = buf; src.loop = true; src.connect(gain); src.start(0);
      currentSrc = src;
    } /* BufferSource in loop mode is standard for continuous noise. [web:313] */

    function playRain(){
      const n = audioCtx.sampleRate * 2;
      const buf = audioCtx.createBuffer(1, n, audioCtx.sampleRate);
      const ch = buf.getChannelData(0);
      for (let i=0;i<n;i++) ch[i] = (Math.random()*2-1)*0.5;
      const lp = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=900;
      const src = audioCtx.createBufferSource();
      src.buffer = buf; src.loop = true; src.connect(lp); lp.connect(gain); src.start(0);
      currentSrc = src;
    } /* Simple filtered noise approximates rain without external assets. [web:313] */
  </script>
</body>
</html>
